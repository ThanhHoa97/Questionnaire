<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Experiment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #video-container, #experiment-section, #questionnaire-container, #scenario-questionnaire-container {
            display: none;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        video {
            display: block;
            margin-top: 20px;
            width: 640px;
            height: 360px;
        }
        .question {
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
    </style>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>

</head>
<body>
    <h1>Welcome to the Experiment</h1>
    <div id="input-section">
        <p>Please enter your Participant ID to begin:</p>
        <input type="number" id="participant-id-input" placeholder="Enter Participant ID">
        <button id="start-button">Start</button>
    </div>

    <div id="experiment-section">
        <div id="scenario-order"></div>
        <div id="video-container">
            <video id="current-video" controls>
                Your browser does not support the video tag.
            </video>
        </div>
        <div id="questionnaire-container">
            <h3>Video Questionnaire</h3>
            <div class="question">
                <label for="video-question1">How engaging was the video? (1-5):</label>
                <input type="number" id="video-question1" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="video-question2">How clear was the content? (1-5):</label>
                <input type="number" id="video-question2" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="video-question3">Additional comments:</label>
                <textarea id="video-question3"></textarea>
            </div>
            <button id="submit-video-questionnaire-button">Submit Video Questionnaire</button>
        </div>
        <div id="scenario-questionnaire-container">
            <h3>Scenario Questionnaire</h3>
            <div class="question">
                <label for="scenario-question1">How challenging was this scenario? (1-5):</label>
                <input type="number" id="scenario-question1" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="scenario-question2">What was your overall experience? (1-5):</label>
                <input type="number" id="scenario-question2" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="scenario-question3">General comments about this scenario:</label>
                <textarea id="scenario-question3"></textarea>
            </div>
            <button id="submit-scenario-questionnaire-button">Submit Scenario Questionnaire</button>
        </div>
        <button id="next-scenario-button" style="display: none;">Next Scenario</button>
    </div>

    <div id="completion-message" class="hidden">
        <button id="send-to-firebase-button">Send Data to Firebase</button>
    </div>

    <script>
        // CSV file URL (replace with your GitHub file URL)
        const csvUrl = "https://raw.githubusercontent.com/ThanhHoa97/Questionnaire/main/latinsquare.csv";
        const messageContainner = document.getElementById('completion-message');
        const sendToFirebase = document.getElementById('send-to-firebase-button');

        // Videos for each scenario
        const videos = {
            "Scenario 1": ["videos/scenario1/video1-1.mp4", "videos/scenario1/video1-2.mp4", "videos/scenario1/video1-3.mp4", "videos/scenario1/video1-4.mp4", "videos/scenario1/video1-5.mp4", "videos/scenario1/video1-6.mp4"],
            "Scenario 2": ["videos/scenario2/video2-1.mp4", "videos/scenario2/video2-2.mp4", "videos/scenario2/video2-3.mp4", "videos/scenario2/video2-4.mp4", "videos/scenario2/video2-5.mp4", "videos/scenario2/video2-6.mp4"],
            "Scenario 3": ["videos/scenario3/video3-1.mp4", "videos/scenario3/video3-2.mp4", "videos/scenario3/video3-3.mp4", "videos/scenario3/video3-4.mp4", "videos/scenario3/video3-5.mp4", "videos/scenario3/video3-6.mp4"],
            "Scenario 4": ["videos/scenario4/video4-1.mp4", "videos/scenario4/video4-2.mp4", "videos/scenario4/video4-3.mp4", "videos/scenario4/video4-4.mp4", "videos/scenario4/video4-5.mp4", "videos/scenario4/video4-6.mp4"],
            "Scenario 5": ["videos/scenario5/video5-1.mp4", "videos/scenario5/video5-2.mp4", "videos/scenario5/video5-3.mp4", "videos/scenario5/video5-4.mp4", "videos/scenario5/video5-5.mp4", "videos/scenario5/video5-6.mp4"]
        };

        // Shuffle an array randomly
        function shuffleArray(array) {
            const shuffled = array.slice(); // Copy the array
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Fetch and parse the CSV file
        async function fetchCSV(url) {
            const response = await fetch(url);
            const data = await response.text();
            const rows = data.trim().split("\n");
            data1 = [];
            rows.forEach(row => {
                // Match the id and the "order" field that might be quoted and contain commas
                const regex = /^(\d+),"(.*)"$/;
                const matches = row.match(regex);

                if (matches) {
                    const id = parseInt(matches[1], 10); // Parse the ID as an integer
                    const order = matches[2].split(",").map(item => item.trim()); // Split the "order" string into an array

                    const parsedData = { id, order };
                    data1.push(parsedData);
                }
            });
            return data1;
        }

        // Store answers
        const answers = [];
        let scenarioData = [];

        // Start the experiment for a given participant ID
        async function startExperiment(participantID) {
            // Fetch and parse the CSV file
            const data = await fetchCSV(csvUrl);

            // Find the participant's scenario order
            const participant = data.find(entry => entry.id === participantID);
            console.log("data : ", data);

            const scenarioOrderDiv = document.getElementById("scenario-order");
            const inputSection = document.getElementById("input-section");
            const experimentSection = document.getElementById("experiment-section");
            const videoContainer = document.getElementById("video-container");
            const questionnaireContainer = document.getElementById("questionnaire-container");
            const scenarioQuestionnaireContainer = document.getElementById("scenario-questionnaire-container");
            const nextScenarioButton = document.getElementById("next-scenario-button");

            if (!participant) {
                alert("Invalid Participant ID. Please try again.");
                return;
            }

            // Hide the input section and show the experiment section
            inputSection.style.display = "none";
            experimentSection.style.display = "block";
            //videoContainer.style.display = "block";

            // Participant's scenario order
            const scenarioOrder = participant.order;
            console.log("scenario order 0 : ", scenarioOrder);
            console.log("participant order 0 : ", participant.order);

            // Variables to track progress
            let currentScenarioIndex = 0;
            let currentVideoIndex = 0;

            let randomizedVideos = shuffleArray(videos[scenarioOrder[currentScenarioIndex]]);

            const videoElement = document.getElementById("current-video");
            const submitVideoQuestionnaireButton = document.getElementById("submit-video-questionnaire-button");
            const submitScenarioQuestionnaireButton = document.getElementById("submit-scenario-questionnaire-button");
            //const submitQuestionnaireButton = document.getElementById("submit-questionnaire-button");
            //const nextVideoButton = document.getElementById("next-video-button");

            // Function to update the video
            const updateVideo = () => {
                const currentScenario = scenarioOrder[currentScenarioIndex];
                //const currentVideos = videos[currentScenario];
                const currentVideos = randomizedVideos;
                console.log("video order : ", currentVideos);

                videoElement.src = currentVideos[currentVideoIndex];

                scenarioOrderDiv.innerHTML = `
                    <h2>Participant ID: ${participantID}</h2>
                    <h3>Current Scenario: ${currentScenario}</h3>
                    <p>Video ${currentVideoIndex + 1} of ${currentVideos.length}</p>
                `;

                // Show the video container and hide the Next Scenario button
                videoContainer.style.display = "block";
                questionnaireContainer.style.display = "block";
                scenarioQuestionnaireContainer.style.display = "none";
                nextScenarioButton.style.display = "none";
            };

            const moveToNextScenario = () => {
                document.getElementById("video-question1").value = "";
                document.getElementById("video-question2").value = "";
                document.getElementById("video-question3").value = "";
                scenarioData = [];
                console.log("scenario data : ", scenarioData);
                currentScenarioIndex++;
                currentVideoIndex = 0;

                if (currentScenarioIndex < scenarioOrder.length) {
                    randomizedVideos = shuffleArray(videos[scenarioOrder[currentScenarioIndex]]);
                    updateVideo();
                } else {
                    scenarioOrderDiv.innerHTML = `<h2>Thank You! You have completed the experiment.</h2>`;
                    videoContainer.style.display = "none";
                    questionnaireContainer.style.display = "none";
                    nextScenarioButton.style.display = "none";
                    messageContainner.classList.remove('hidden');
                    console.log("Final Answers:", answers);
                }
            };


            const moveToNextVideo = () => {
                const currentVideos = randomizedVideos;

                if (currentVideoIndex < currentVideos.length - 1) {
                    currentVideoIndex++;
                    updateVideo();
                } else {
                    questionnaireContainer.style.display = "none";
                    //scenarioQuestionnaireContainer.style.display = "block";
                    console.log("scenario ques : ");
                    //nextScenarioButton.style.display = "block";
                }
            };


            // Event listener for the "Submit Questionnaire" button
            submitVideoQuestionnaireButton.addEventListener("click", () => {
                const videoQuestion1 = document.getElementById("video-question1").value;
                const videoQuestion2 = document.getElementById("video-question2").value;
                const videoQuestion3 = document.getElementById("video-question3").value;

                if (!videoQuestion1 || !videoQuestion2) {
                    alert("Please answer all required questions.");
                    return;
                }
                console.log("current video indexe ", currentVideoIndex);
                // Save the responses
                answers.push({
                    participantID,
                    scenario: scenarioOrder[currentScenarioIndex],
                    video: randomizedVideos[currentVideoIndex],
                    responses: { videoQuestion1, videoQuestion2, videoQuestion3 }
                });
                scenarioData.push({
                    participantID,
                    scenario: scenarioOrder[currentScenarioIndex],
                    video: randomizedVideos[currentVideoIndex],
                    responses: { videoQuestion1, videoQuestion2, videoQuestion3 }
                });
                if (currentVideoIndex >= 5)
                {
                    questionnaireContainer.style.display = "none";
                    videoContainer.style.display = "none";
                    scenarioQuestionnaireContainer.style.display = "block";
                    //nextScenarioButton.style.display = "block";
                }
                else {
                    document.getElementById("video-question1").value = "";
                    document.getElementById("video-question2").value = "";
                    document.getElementById("video-question3").value = "";

                    moveToNextVideo();
                }
                // Reset the questionnaire
                
            });

            submitScenarioQuestionnaireButton.addEventListener("click", () => {
                const scenarioQuestion1 = document.getElementById("scenario-question1").value;
                const scenarioQuestion2 = document.getElementById("scenario-question2").value;
                const scenarioQuestion3 = document.getElementById("scenario-question3").value;

                if (!scenarioQuestion1 || !scenarioQuestion2) {
                    alert("Please answer all required questions.");
                    return;
                }

                answers.push({
                    participantID,
                    scenario: scenarioOrder[currentScenarioIndex],
                    scenarioResponses: { scenarioQuestion1, scenarioQuestion2, scenarioQuestion3 }
                });

                scenarioData.push({
                    participantID,
                    scenario: scenarioOrder[currentScenarioIndex],
                    responses: { scenarioQuestion1, scenarioQuestion2, scenarioQuestion3  }
                });

                //document.getElementById("scenario-question1").value = "";
                //document.getElementById("scenario-question2").value = "";
                //document.getElementById("scenario-question3").value = "";

                nextScenarioButton.style.display = "block";
            });

            nextScenarioButton.addEventListener("click", moveToNextScenario);

            // Initialize the first video
            updateVideo();

            

        }

        
        // Event listener for the "Start" button
        document.getElementById("start-button").addEventListener("click", () => {
            const participantIDInput = document.getElementById("participant-id-input").value;
            const participantID = parseInt(participantIDInput, 10);

            if (!participantID || participantID < 1) {
                alert("Please enter a valid Participant ID.");
                return;
            }

            startExperiment(participantID);
        });

        // send data to firebase for each scenario
        //sendToFirebase.addEventListener("click", sendDataToFirebase);


    </script>
    <script src="sendToFireBase.js"></script>
</body>
</html>
