<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Experiment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #video-container, #experiment-section {
            display: none;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        video {
            display: block;
            margin-top: 20px;
            width: 640px;
            height: 360px;
        }
        .question {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Welcome to the Experiment</h1>
    <div id="input-section">
        <p>Please enter your Participant ID to begin:</p>
        <input type="number" id="participant-id-input" placeholder="Enter Participant ID">
        <button id="start-button">Start</button>
    </div>

    <div id="experiment-section">
        <div id="scenario-order"></div>
        <div id="video-container">
            <video id="current-video" controls>
                Your browser does not support the video tag.
            </video>
        </div>
        <div id="questionnaire-container">
            <h3>Questionnaire</h3>
            <div class="question">
                <label for="question1">How engaging was the video? (1-5):</label>
                <input type="number" id="question1" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="question2">How clear was the content? (1-5):</label>
                <input type="number" id="question2" min="1" max="5" required>
            </div>
            <div class="question">
                <label for="question3">Additional comments:</label>
                <textarea id="question3"></textarea>
            </div>
            <button id="submit-questionnaire-button">Submit Questionnaire</button>
        </div>
        <button id="next-scenario-button" style="display: none;">Next Scenario</button>
    </div>

    <script>
        // CSV file URL (replace with your GitHub file URL)
        const csvUrl = "https://raw.githubusercontent.com/ThanhHoa97/Questionnaire/main/latinsquare.csv";

        // Videos for each scenario
        const videos = {
            "Scenario 1": ["videos/scenario1/video1-1.mp4", "videos/scenario1/video1-2.mp4", "videos/scenario1/video1-3.mp4", "videos/scenario1/video1-4.mp4", "videos/scenario1/video1-5.mp4", "videos/scenario1/video1-6.mp4"],
            "Scenario 2": ["videos/scenario2/video2-1.mp4", "videos/scenario2/video2-2.mp4", "videos/scenario2/video2-3.mp4", "videos/scenario2/video2-4.mp4", "videos/scenario2/video2-5.mp4", "videos/scenario2/video2-6.mp4"],
            "Scenario 3": ["videos/scenario3/video3-1.mp4", "videos/scenario3/video3-2.mp4", "videos/scenario3/video3-3.mp4", "videos/scenario3/video3-4.mp4", "videos/scenario3/video3-5.mp4", "videos/scenario3/video3-6.mp4"],
            "Scenario 4": ["videos/scenario4/video4-1.mp4", "videos/scenario4/video4-2.mp4", "videos/scenario4/video4-3.mp4", "videos/scenario4/video4-4.mp4", "videos/scenario4/video4-5.mp4", "videos/scenario4/video4-6.mp4"],
            "Scenario 5": ["videos/scenario5/video5-1.mp4", "videos/scenario5/video5-2.mp4", "videos/scenario5/video5-3.mp4", "videos/scenario5/video5-4.mp4", "videos/scenario5/video5-5.mp4", "videos/scenario5/video5-6.mp4"]
        };

        // Shuffle an array randomly
        function shuffleArray(array) {
            const shuffled = array.slice(); // Copy the array
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Fetch and parse the CSV file
        async function fetchCSV(url) {
            const response = await fetch(url);
            const data = await response.text();
            const rows = data.trim().split("\n");
            data1 = [];
            rows.forEach(row => {
                // Match the id and the "order" field that might be quoted and contain commas
                const regex = /^(\d+),"(.*)"$/;
                const matches = row.match(regex);

                if (matches) {
                    const id = parseInt(matches[1], 10); // Parse the ID as an integer
                    const order = matches[2].split(",").map(item => item.trim()); // Split the "order" string into an array

                    const parsedData = { id, order };
                    data1.push(parsedData);
                }
            });
            return data1;
        }

        // Store answers
        const answers = [];


        // Start the experiment for a given participant ID
        async function startExperiment(participantID) {
            // Fetch and parse the CSV file
            const data = await fetchCSV(csvUrl);

            // Find the participant's scenario order
            const participant = data.find(entry => entry.id === participantID);
            console.log("data : ", data);

            const scenarioOrderDiv = document.getElementById("scenario-order");
            const inputSection = document.getElementById("input-section");
            const experimentSection = document.getElementById("experiment-section");
            const videoContainer = document.getElementById("video-container");
            const questionnaireContainer = document.getElementById("questionnaire-container");
            const nextScenarioButton = document.getElementById("next-scenario-button");

            if (!participant) {
                alert("Invalid Participant ID. Please try again.");
                return;
            }

            // Hide the input section and show the experiment section
            inputSection.style.display = "none";
            experimentSection.style.display = "block";
            videoContainer.style.display = "block";

            // Participant's scenario order
            const scenarioOrder = participant.order;
            console.log("scenario order 0 : ", scenarioOrder);
            console.log("participant order 0 : ", participant.order);

            // Variables to track progress
            let currentScenarioIndex = 0;
            let currentVideoIndex = 0;

            let randomizedVideos = shuffleArray(videos[scenarioOrder[currentScenarioIndex]]);

            const videoElement = document.getElementById("current-video");
            const submitQuestionnaireButton = document.getElementById("submit-questionnaire-button");
            //const nextVideoButton = document.getElementById("next-video-button");

            // Function to update the video
            const updateVideo = () => {
                const currentScenario = scenarioOrder[currentScenarioIndex];
                //const currentVideos = videos[currentScenario];
                const currentVideos = randomizedVideos;
                console.log("video order : ", currentVideos);

                videoElement.src = currentVideos[currentVideoIndex];

                scenarioOrderDiv.innerHTML = `
                    <h2>Participant ID: ${participantID}</h2>
                    <h3>Current Scenario: ${currentScenario}</h3>
                    <p>Video ${currentVideoIndex + 1} of ${currentVideos.length}</p>
                `;

                // Show the video container and hide the Next Scenario button
                videoContainer.style.display = "block";
                questionnaireContainer.style.display = "block";
                nextScenarioButton.style.display = "none";
            };

            // Function to move to the next video or scenario
            const moveToNext = () => {
                const currentVideos = randomizedVideos;

                if (currentVideoIndex < currentVideos.length - 1) {
                    // Move to the next video
                    currentVideoIndex++;
                    updateVideo();
                } else if (currentScenarioIndex < scenarioOrder.length - 1) {
                    // Move to the next scenario
                    currentScenarioIndex++;
                    currentVideoIndex = 0;
                    randomizedVideos = shuffleArray(videos[scenarioOrder[currentScenarioIndex]]);
                    updateVideo();
                } else {
                    // End of the experiment
                    scenarioOrderDiv.innerHTML = `
                        <h2>Thank You!</h2>
                        <p>You have completed all scenarios and videos.</p>
                    `;
                    videoContainer.style.display = "none";
                    questionnaireContainer.style.display = "none";
                    nextScenarioButton.style.display = "none";
                    console.log("Final Answers:", answers);
                }
            };

            // Event listener for the "Submit Questionnaire" button
            submitQuestionnaireButton.addEventListener("click", () => {
                const question1 = document.getElementById("question1").value;
                const question2 = document.getElementById("question2").value;
                const question3 = document.getElementById("question3").value;

                if (!question1 || !question2) {
                    alert("Please answer all required questions.");
                    return;
                }

                // Save the responses
                answers.push({
                    participantID,
                    scenario: scenarioOrder[currentScenarioIndex],
                    video: randomizedVideos[currentVideoIndex],
                    responses: { question1, question2, question3 }
                });

                // Reset the questionnaire
                document.getElementById("question1").value = "";
                document.getElementById("question2").value = "";
                document.getElementById("question3").value = "";

                moveToNext();
            });

            // Initialize the first video
            updateVideo();
        }

        // Event listener for the "Start" button
        document.getElementById("start-button").addEventListener("click", () => {
            const participantIDInput = document.getElementById("participant-id-input").value;
            const participantID = parseInt(participantIDInput, 10);

            if (!participantID || participantID < 1) {
                alert("Please enter a valid Participant ID.");
                return;
            }

            startExperiment(participantID);
        });
    </script>
</body>
</html>
